# AudiobookSmith V13.1 - Implementation Plan

## üéØ Goal
Fix all inherited formatting issues from V12 while preserving V13's AI-powered features.

---

## üêõ Issues to Fix

### Issue 1: Prologue Appears Twice ‚ö†Ô∏è CRITICAL
**Current Behavior:**
- Row 1: "Prologue iv" (16,856 words)
- Row 48: "Prologue" (16,856 words) - DUPLICATE

**Root Cause:**
The TOC has two Prologue entries:
```
Line 38: "Prologue iv" (with page number)
Line 90: "Prologue" (without page number, at end of TOC)
```

Both entries match the same content in the body text, resulting in duplicate chapter files.

**Impact:** 
- Confuses narrators
- Wastes processing time
- Incorrect chapter count (48 instead of 47)

---

### Issue 2: Epilogue Missing ‚ö†Ô∏è CRITICAL
**Current Behavior:**
- TOC lists: "Epilogue 359"
- V13 output: "‚úó Not found: Epilogue 359"
- Result: No Epilogue chapter file created

**Root Cause:**
The search pattern doesn't match the actual Epilogue format in the body text. Possible reasons:
1. Case sensitivity ("EPILOGUE" vs "Epilogue")
2. Page number interference ("359" attached to title)
3. Different formatting in body vs TOC

**Impact:**
- Missing required ACX/Audible element
- Incomplete book narration
- 98% accuracy instead of 100%

---

### Issue 3: Chapter Titles Concatenated ‚ö†Ô∏è HIGH
**Current Behavior:**
- TOC: "1 OnceUponaTime"
- Should be: "1 Once Upon a Time"
- Also affects: MyFirstMisadventure, LullabiesintheRain, etc.

**Root Cause:**
The TOC extraction preserves camelCase formatting from the PDF without adding spaces. The V7 PERFECT camelCase splitter is not being applied to the final chapter titles displayed in the analysis page.

**Impact:**
- Unprofessional appearance
- Harder to read
- Doesn't match actual book formatting

---

## üîß Technical Solutions

### Solution 1: Deduplicate Prologue

**Approach: Content-Based Deduplication**

```python
def deduplicate_chapters(chapters):
    """
    Remove duplicate chapters based on content similarity.
    Keep the first occurrence, remove subsequent duplicates.
    """
    seen_content = {}
    unique_chapters = []
    
    for chapter in chapters:
        # Create content fingerprint (first 500 + last 500 chars)
        fingerprint = chapter['text'][:500] + chapter['text'][-500:]
        
        # Check if we've seen similar content
        is_duplicate = False
        for seen_fp, seen_title in seen_content.items():
            similarity = calculate_similarity(fingerprint, seen_fp)
            if similarity > 0.95:  # 95% similar = duplicate
                logger.warning(f"  ‚úó Duplicate removed: {chapter['title']} "
                             f"(matches {seen_title})")
                is_duplicate = True
                break
        
        if not is_duplicate:
            unique_chapters.append(chapter)
            seen_content[fingerprint] = chapter['title']
            logger.info(f"  ‚úì Unique: {chapter['title']}")
    
    return unique_chapters
```

**Implementation Steps:**
1. After chapter extraction, before saving files
2. Compare content fingerprints (first 500 + last 500 chars)
3. Calculate similarity using difflib.SequenceMatcher
4. Remove chapters with >95% similarity
5. Log which duplicates were removed

**Expected Result:**
- Only one Prologue remains (the first occurrence)
- 47 unique chapters instead of 48

---

### Solution 2: Fix Epilogue Detection

**Approach: Multi-Pattern Search with Case Insensitivity**

```python
def find_epilogue(full_text, toc_entry):
    """
    Search for Epilogue using multiple patterns and strategies.
    """
    # Extract title without page number
    epilogue_title = re.sub(r'\s+\d+$', '', toc_entry).strip()
    
    # Try multiple search patterns
    patterns = [
        # Pattern 1: Exact match (case-insensitive)
        r'(?i)^EPILOGUE\s*$',
        
        # Pattern 2: With page number
        r'(?i)^EPILOGUE\s+\d+\s*$',
        
        # Pattern 3: All caps
        r'^EPILOGUE\s*$',
        
        # Pattern 4: Title case
        r'^Epilogue\s*$',
        
        # Pattern 5: With optional page break markers
        r'(?i)^EPILOGUE\s*(?:<PAGE_\d+>)?\s*$',
    ]
    
    for pattern in patterns:
        matches = re.finditer(pattern, full_text, re.MULTILINE)
        for match in matches:
            # Verify it's not in TOC section
            if match.start() > toc_end_position:
                logger.info(f"  ‚úì Found Epilogue using pattern: {pattern}")
                return match.start()
    
    # Fallback: Search for "EPILOGUE" anywhere after TOC
    fallback_match = re.search(r'(?i)EPILOGUE', full_text[toc_end_position:])
    if fallback_match:
        logger.warning(f"  ‚ö† Found Epilogue using fallback search")
        return toc_end_position + fallback_match.start()
    
    logger.error(f"  ‚úó Epilogue not found with any pattern")
    return None
```

**Implementation Steps:**
1. Add case-insensitive search
2. Try multiple patterns (all caps, title case, with/without page numbers)
3. Verify match is after TOC section
4. Use fallback search if primary patterns fail
5. Log which pattern successfully found Epilogue

**Expected Result:**
- Epilogue found and extracted
- 49 chapters total (Prologue + 1-46 + Epilogue, minus 1 duplicate = 48 unique)

---

### Solution 3: Format Chapter Titles with Spaces

**Approach: Apply V7 PERFECT CamelCase Splitter to Display Titles**

```python
def format_chapter_title(raw_title):
    """
    Format chapter titles with proper spacing.
    Applies V7 PERFECT camelCase splitting algorithm.
    """
    # Extract chapter number and title
    match = re.match(r'^(\d+)\s+(.+)$', raw_title)
    if match:
        chapter_num = match.group(1)
        title_text = match.group(2)
    else:
        # No chapter number (e.g., Prologue, Epilogue)
        chapter_num = None
        title_text = raw_title
    
    # Apply V7 PERFECT camelCase splitting
    formatted_title = split_camel_case_v7(title_text)
    
    # Reconstruct with chapter number
    if chapter_num:
        return f"{chapter_num} {formatted_title}"
    else:
        return formatted_title

def split_camel_case_v7(text):
    """
    V7 PERFECT camelCase splitting algorithm.
    Handles all edge cases including:
    - OnceUponaTime -> Once Upon a Time
    - MyFirstMisadventure -> My First Misadventure
    - IntoAdulthood -> Into Adulthood
    """
    # Step 0: Handle single uppercase letters
    text = re.sub(r'([A-Z])([A-Z][a-z])', r'\1 \2', text)
    
    # Step 0.5: Handle "into" at word start
    if text.lower().startswith('into') and len(text) > 4 and text[4].isupper():
        text = text[:4] + ' ' + text[4:]
    
    # Step 1: Compound connectors (before they get split)
    compound_connectors = [
        ('ofthe', 'of the'), ('inthe', 'in the'), ('onthe', 'on the'),
        ('tothe', 'to the'), ('forthe', 'for the'), ('andthe', 'and the'),
        ('ofmy', 'of my'), ('inmy', 'in my'), ('tomy', 'to my'),
    ]
    for old, new in compound_connectors:
        text = re.sub(f'(?i){old}', new, text)
    
    # Step 2: Single connectors
    connectors = ['of', 'the', 'and', 'for', 'in', 'a', 'to', 'upon', 'with']
    for connector in connectors:
        pattern = f'([a-z])({connector})([A-Z])'
        text = re.sub(pattern, r'\1 \2 \3', text, flags=re.IGNORECASE)
    
    # Step 3: General camelCase (lowercase to uppercase)
    text = re.sub(r'([a-z])([A-Z])', r'\1 \2', text)
    
    # Step 4: Clean up multiple spaces
    text = re.sub(r'\s+', ' ', text).strip()
    
    return text
```

**Implementation Steps:**
1. After chapter extraction, before generating analysis page
2. Apply `format_chapter_title()` to each chapter title
3. Store both raw title (for file naming) and formatted title (for display)
4. Use formatted title in analysis page HTML
5. Keep raw title for chapter file names (avoid special characters)

**Expected Result:**
- Display: "1 Once Upon a Time"
- File name: "01_OnceUponaTime.txt" (safe for filesystem)
- All chapter titles properly formatted in analysis page

---

## üìã V13.1 Implementation Checklist

### Phase 1: Code Changes (2-3 hours)

#### 1.1 Add Deduplication Function
- [ ] Create `deduplicate_chapters()` function
- [ ] Implement content fingerprinting
- [ ] Add similarity calculation
- [ ] Integrate after chapter extraction
- [ ] Add logging for removed duplicates

#### 1.2 Enhance Epilogue Detection
- [ ] Create `find_epilogue()` with multi-pattern search
- [ ] Add case-insensitive patterns
- [ ] Implement fallback search
- [ ] Test with VITALY book
- [ ] Verify Epilogue is found

#### 1.3 Add Title Formatting
- [ ] Create `format_chapter_title()` function
- [ ] Integrate V7 PERFECT camelCase splitter
- [ ] Apply to analysis page display
- [ ] Keep raw titles for file names
- [ ] Test with all chapter titles

#### 1.4 Update Analysis Page Template
- [ ] Use formatted titles in chapter table
- [ ] Add tooltip showing raw title
- [ ] Update CSS for better readability
- [ ] Test responsive design

### Phase 2: Testing (1-2 hours)

#### 2.1 Unit Tests
- [ ] Test deduplication with duplicate content
- [ ] Test Epilogue detection with various formats
- [ ] Test camelCase splitting with edge cases
- [ ] Verify all 13 V7 PERFECT test cases pass

#### 2.2 Integration Tests
- [ ] Run V13.1 on VITALY book
- [ ] Verify Prologue appears only once
- [ ] Verify Epilogue is found
- [ ] Verify all titles properly formatted
- [ ] Check total chapter count (47-48 unique)

#### 2.3 Regression Tests
- [ ] Verify AI voice recommendations still work
- [ ] Verify cultural analysis intact
- [ ] Verify book metadata displays correctly
- [ ] Verify analysis page design unchanged

### Phase 3: Documentation (30 min)

#### 3.1 Update Documentation
- [ ] Update V13.1_DEPLOYMENT_INSTRUCTIONS.md
- [ ] Document new features
- [ ] Update known issues section (remove fixed issues)
- [ ] Add before/after comparison

#### 3.2 Create Release Notes
- [ ] List all fixes
- [ ] Show before/after examples
- [ ] Highlight improvements
- [ ] Include upgrade instructions

### Phase 4: Deployment (30 min)

#### 4.1 GitHub
- [ ] Commit V13.1 code
- [ ] Push to main branch
- [ ] Create release tag (v13.1)
- [ ] Update README

#### 4.2 Production
- [ ] Deploy to production server
- [ ] Run test with VITALY book
- [ ] Verify all fixes working
- [ ] Update web access if needed

---

## üéØ Expected Results

### Before V13.1 (Current V13):
```
Chapters: 48 (with issues)
- Row 1: Prologue iv (16,856 words)
- Row 2: 1 OnceUponaTime (16,373 words)
- Row 3: 2 MyFirstMisadventure (16,210 words)
- ...
- Row 48: Prologue (16,856 words) ‚ùå DUPLICATE
- Epilogue: ‚ùå MISSING
```

### After V13.1 (Fixed):
```
Chapters: 47 (all unique, properly formatted)
- Row 1: Prologue (16,856 words) ‚úÖ
- Row 2: 1 Once Upon a Time (16,373 words) ‚úÖ
- Row 3: 2 My First Misadventure (16,210 words) ‚úÖ
- Row 4: 3 Lullabies in the Rain (15,865 words) ‚úÖ
- ...
- Row 46: 45 Choices (16,483 words) ‚úÖ
- Row 47: Epilogue (TBD words) ‚úÖ FOUND
```

---

## üìä Success Metrics

### Quantitative:
- ‚úÖ Prologue count: 1 (currently 2)
- ‚úÖ Epilogue found: Yes (currently No)
- ‚úÖ Unique chapters: 47 (currently 48 with duplicate)
- ‚úÖ Properly formatted titles: 100% (currently 0%)
- ‚úÖ Overall accuracy: 100% (currently 98%)

### Qualitative:
- ‚úÖ Professional appearance
- ‚úÖ ACX/Audible compliant
- ‚úÖ Narrator-friendly
- ‚úÖ No manual fixes needed
- ‚úÖ Production-ready

---

## ‚è±Ô∏è Timeline

### Immediate (Next Session):
- **Phase 1:** Code changes (2-3 hours)
- **Phase 2:** Testing (1-2 hours)
- **Phase 3:** Documentation (30 min)
- **Phase 4:** Deployment (30 min)

**Total: 4-6 hours**

### Deliverables:
1. ‚úÖ V13.1 processor with all fixes
2. ‚úÖ Complete test results
3. ‚úÖ Updated documentation
4. ‚úÖ Deployment guide
5. ‚úÖ Before/after comparison

---

## üîÑ Backwards Compatibility

### V13 ‚Üí V13.1 Upgrade:
- ‚úÖ **No breaking changes**
- ‚úÖ Same command-line interface
- ‚úÖ Same output directory structure
- ‚úÖ Same analysis page format
- ‚úÖ All V13 features preserved

### Migration:
```bash
# Simple upgrade
cd /var/www/audiobooksmith
git pull origin main

# Re-process books to get fixes
python3 audiobook_processor_v13.1.py /path/to/book.pdf
```

---

## üéØ Priority

**CRITICAL:** All three issues affect production quality
- Prologue duplicate: Confuses narrators
- Missing Epilogue: Incomplete book (ACX requirement)
- Concatenated titles: Unprofessional appearance

**Recommendation:** Implement V13.1 immediately after V13 deployment.

---

## ‚úÖ Approval Checklist

Before starting V13.1 implementation:
- [ ] User reviewed this plan
- [ ] User approved approach
- [ ] User confirmed priority
- [ ] User ready for next session
- [ ] All questions answered

---

**This plan provides a complete roadmap for V13.1. Ready to implement in the next session!** üöÄ
