<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Analysis - AudiobookSmith</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .badge {
            display: inline-block;
            padding: 8px 16px;
            background: #10b981;
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .section-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 20px;
            color: #333;
            font-weight: 600;
        }
        
        /* Voice Selection Styles */
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .voice-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .voice-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .voice-card.selected {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .voice-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .voice-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .match-score {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .voice-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .voice-labels {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .voice-label {
            background: #e0e7ff;
            color: #4c51bf;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
        }
        
        .voice-player {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        audio {
            width: 100%;
            height: 40px;
        }
        
        .select-voice-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .select-voice-btn:hover {
            background: #5568d3;
        }
        
        .select-voice-btn.selected {
            background: #10b981;
        }
        
        .voice-criteria {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .criteria-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 10px;
        }
        
        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .criteria-item {
            font-size: 14px;
            color: #856404;
        }
        
        .criteria-label {
            font-weight: 600;
        }
        
        .match-reason {
            background: #e0f2fe;
            border-left: 3px solid #0284c7;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            color: #0c4a6e;
            margin-top: 10px;
        }
        
        .no-voices-message {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .folder-tree {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            line-height: 1.6;
        }
        
        .folder-icon {
            color: #4fc3f7;
        }
        
        .file-icon {
            color: #81c784;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="card header">
            <h1>üìö Book Analysis Complete!</h1>
            <div class="badge">‚úì Processing Successful</div>
        </div>
        
        <!-- Book Information -->
        <div class="card">
            <div class="section-title">üìñ Book Information</div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Title</div>
                    <div class="info-value">{{ analysis.bookInfo.title }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Word Count</div>
                    <div class="info-value">{{ "{:,}".format(analysis.metrics.word_count) }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Pages</div>
                    <div class="info-value">{{ analysis.metrics.page_count }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Reading Time</div>
                    <div class="info-value">{{ analysis.metrics.reading_time }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Audio Length</div>
                    <div class="info-value">{{ analysis.metrics.audio_length }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Genre</div>
                    <div class="info-value">{{ analysis.bookInfo.genre }}</div>
                </div>
            </div>
        </div>
        
        <!-- Voice Selection -->
        {% if analysis.voiceRecommendations %}
        <div class="card">
            <div class="section-title">üéôÔ∏è Select Your Narrator Voice</div>
            
            <div class="voice-criteria">
                <div class="criteria-title">‚ú® Recommended Voice Characteristics for Your Book:</div>
                <div class="criteria-grid">
                    <div class="criteria-item">
                        <span class="criteria-label">Gender:</span> {{ analysis.voiceRecommendations.voice_criteria.gender }}
                    </div>
                    <div class="criteria-item">
                        <span class="criteria-label">Age:</span> {{ analysis.voiceRecommendations.voice_criteria.age_range }}
                    </div>
                    <div class="criteria-item">
                        <span class="criteria-label">Accent:</span> {{ analysis.voiceRecommendations.voice_criteria.accent }}
                    </div>
                    <div class="criteria-item">
                        <span class="criteria-label">Tone:</span> {{ analysis.voiceRecommendations.voice_criteria.tone }}
                    </div>
                </div>
                <p style="margin-top: 10px; font-size: 13px;">
                    <strong>Why:</strong> {{ analysis.voiceRecommendations.voice_criteria.reasoning }}
                </p>
            </div>
            
            <p style="margin-bottom: 20px; color: #666;">
                We've analyzed your book and selected the top 5 narrator voices that best match its style and tone. 
                Listen to each sample (using text from your book) and select your preferred voice.
            </p>
            
            <div class="voice-grid">
                {% for voice in analysis.voiceRecommendations.recommended_voices %}
                <div class="voice-card" id="voice-{{ voice.voice_id }}" onclick="selectVoice('{{ voice.voice_id }}', '{{ voice.name }}')">
                    <div class="voice-header">
                        <div>
                            <div class="voice-name">{{ voice.name }}</div>
                            {% if voice.labels %}
                            <div class="voice-labels">
                                {% if voice.labels.get('gender') %}
                                <span class="voice-label">{{ voice.labels.gender }}</span>
                                {% endif %}
                                {% if voice.labels.get('accent') %}
                                <span class="voice-label">{{ voice.labels.accent }}</span>
                                {% endif %}
                                {% if voice.labels.get('age') %}
                                <span class="voice-label">{{ voice.labels.age }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="match-score">{{ voice.match_score }}% Match</div>
                    </div>
                    
                    <div class="voice-description">{{ voice.description or 'Professional narrator voice' }}</div>
                    
                    {% if voice.match_reason %}
                    <div class="match-reason">
                        <strong>Why this voice:</strong> {{ voice.match_reason }}
                    </div>
                    {% endif %}
                    
                    {% if voice.sample_generated and voice.sample_path %}
                    <div class="voice-player">
                        <audio controls preload="metadata">
                            <source src="/files/voice-sample/{{ analysis.sessionId }}/{{ voice.voice_id }}.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                    {% endif %}
                    
                    <button class="select-voice-btn" id="btn-{{ voice.voice_id }}">
                        Select This Voice
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Folder Structure -->
        <div class="card">
            <div class="section-title">üìÅ Server Folder Structure</div>
            <p style="margin-bottom: 15px; color: #666;">
                Session ID: <strong>{{ analysis.sessionId }}</strong><br>
                Total Files: <strong>{{ analysis.folderStructure.file_count }}</strong> | 
                Total Folders: <strong>{{ analysis.folderStructure.folder_count }}</strong> | 
                Total Size: <strong>{{ analysis.folderStructure.total_size_formatted }}</strong>
            </p>
            
            <div class="folder-tree">
<div>üìÅ {{ analysis.sessionId }}/</div>
{% for folder in analysis.folderStructure.folders|sort(attribute='path') %}
<div>{{ '  ' * (folder.level + 1) }}<span class="folder-icon">‚îú‚îÄ üìÇ</span> {{ folder.name }}/</div>
{% endfor %}
{% for file in analysis.folderStructure.files|sort(attribute='path') %}
<div>{{ '  ' * (file.level + 1) }}<span class="file-icon">‚îú‚îÄ üìÑ</span> {{ file.name }} <span style="color: #888;">({{ file.size_formatted }})</span></div>
{% endfor %}
            </div>
        </div>
    </div>
    
    <script>
        let selectedVoiceId = null;
        
        function selectVoice(voiceId, voiceName) {
            // Remove previous selection
            document.querySelectorAll('.voice-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelectorAll('.select-voice-btn').forEach(btn => {
                btn.classList.remove('selected');
                btn.textContent = 'Select This Voice';
            });
            
            // Add new selection
            const card = document.getElementById('voice-' + voiceId);
            const btn = document.getElementById('btn-' + voiceId);
            card.classList.add('selected');
            btn.classList.add('selected');
            btn.textContent = '‚úì Selected';
            
            selectedVoiceId = voiceId;
            
            // Save selection to server
            saveVoiceSelection(voiceId, voiceName);
        }
        
        function saveVoiceSelection(voiceId, voiceName) {
            const sessionId = '{{ analysis.sessionId }}';
            const projectId = '{{ analysis.projectId }}';
            
            fetch('/webhook/select-voice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sessionId: sessionId,
                    projectId: projectId,
                    voiceId: voiceId,
                    voiceName: voiceName
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Voice selection saved:', data);
                // Show success message
                showNotification('Voice selected: ' + voiceName);
            })
            .catch(error => {
                console.error('Error saving voice selection:', error);
            });
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
    
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</body>
</html>
